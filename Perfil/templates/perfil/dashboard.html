{% extends 'layouts/base.html' %}
{% load static %} {# <-- ¡Esta línea DEBE ESTAR! #}

{% block title %} Dashboard {% endblock title %}

{% block stylesheets %}
    {{ block.super }}
    {# Carga tu CSS de progreso, que ahora contendrá los estilos para el gráfico D3.js #}
    <link rel="stylesheet" href="{% static 'assets/css/progreso.css' %}">
{% endblock stylesheets %}

{% block content %}

    <div class="header bg-primary pb-6"> {# Este div se mantiene morado #}
        <div class="container-fluid">
            <div class="header-body">
                <div class="row align-items-center py-4">
                    <div class="col-lg-6 col-7">
                        <h6 class="h2 text-white d-inline-block mb-0">Default</h6>
                        <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                            <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                                <li class="breadcrumb-item"><a href="#" class="text-primary"><i class="fas fa-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="#" class="text-primary">Dashboards</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Default</li>
                            </ol>
                        </nav>
                    </div>
                </div>
                <div class="row d-flex justify-content-around">
                    <div class="col-xl-3 col-md-6">
                        <div class="card card-stats">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col">
                                        <h5 class="card-title text-uppercase text-muted mb-0">Usuario Actual</h5>
                                        <span class="h2 font-weight-bold mb-0">{{ request.user.username|upper }}</span>
                                    </div>
                                    <div class="col-auto">
                                        <div class="icon icon-shape bg-gradient-red text-white rounded-circle shadow">
                                            <i class="ni ni-single-02"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card card-stats">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col">
                                        <h5 class="card-title text-uppercase text-muted mb-0">Tipo de Cuerpo</h5>
                                        <span class="h2 font-weight-bold mb-0">
                                            {% if tipo_cuerpo %}
                                                {{ tipo_cuerpo|default:"No determinado" }}
                                            {% else %}
                                                No determinado
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="col-auto">
                                        <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                                            <i class="fas fa-male"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card card-stats">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col">
                                        <h5 class="card-title text-uppercase text-muted mb-0">Progreso</h5>
                                        <span class="h2 font-weight-bold mb-0">Balanceado</span>
                                    </div>
                                    <div class="col-auto">
                                        <div class="icon icon-shape bg-gradient-blue text-white rounded-circle shadow">
                                            <!-- Icono de Font Awesome que representa un gráfico de línea, ideal para progreso -->
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="container-fluid mt--6">
        <div class="row">
            {# CAMBIO AQUÍ: Eliminado bg-default y ajustados colores de texto #}
            <div class="col-xl-8">
                <div class="card"> {# Removido bg-default #}
                    <div class="card-header bg-transparent">
                        <div class="row align-items-center">
                            <div class="col">
                                {# Texto ahora oscuro para contraste con fondo blanco #}
                                <h6 class="text-uppercase text-muted ls-1 mb-1">Tu Evolución</h6>
                                <h5 class="h3 mb-0">Progreso de Peso (kg)</h5> {# H3 por defecto es oscuro #}
                            </div>
                            <div class="col">
                                {# Elemento para mostrar el peso seleccionado en el dashboard #}
                                <div class="mt-2 text-xl font-bold text-blue-600 text-right" id="selected-weight-display-dashboard">
                                    <!-- Aquí se mostrará el peso seleccionado. -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart" id="weight-chart-container-dashboard">
                            {# D3.js insertará el elemento <svg> aquí #}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4">
                <div class="card">
                    <div class="card-header bg-transparent">
                        <div class="row align-items-center">
                            <div class="col">
                                <h6 class="text-uppercase text-muted ls-1 mb-1">Tu Tipo de Cuerpo</h6>
                                <h5 class="h3 mb-0">
                                    {% if tipo_cuerpo %}
                                        {{ tipo_cuerpo|default:"No determinado" }}
                                    {% else %}
                                        No determinado
                                    {% endif %}
                                </h5>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart">
                            {# Este div.chart se quedará vacío o puedes poner un mensaje aquí si no habrá otro gráfico #}
                            <p class="text-center text-gray-500 mt-5">Detalles del tipo de cuerpo.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            {# INICIO DEL DIV MODIFICADO: col-xl-8 con la tabla de Últimas Mediciones #}
            <div class="col-xl-8">
                <div class="card">
                    <div class="card-header border-0">
                        <div class="row align-items-center">
                            <div class="col">
                                <h3 class="mb-0">Últimas Mediciones</h3> {# Título de la tabla #}
                            </div>
                            <div class="col text-right">
                                {# Enlace a la página de progreso usando el nombre de URL correcto #}
                                <a href="{% url 'progreso:progreso_home' %}" class="btn btn-sm btn-primary">Ver todas</a>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table align-items-center table-flush">
                            <thead class="thead-light">
                                <tr>
                                    <th scope="col">Fecha y Hora</th>
                                    <th scope="col">Peso (kg)</th>
                                    <th scope="col">Estatura (cm)</th>
                                    <th scope="col">IMC</th>
                                    <th scope="col">Tipo de Cuerpo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {# Aquí se poblarán las mediciones recientes desde la vista #}
                                {% for medicion in mediciones_recientes %}
                                <tr>
                                    <td>{{ medicion.fecha_medicion|date:"d M Y H:i" }}</td>
                                    <td>{{ medicion.peso|floatformat:1 }}</td>
                                    <td>{{ medicion.estatura|floatformat:0 }}</td>
                                    <td>
                                        {% if medicion.imc_valor is not None %}
                                            {{ medicion.imc_valor|floatformat:1 }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ medicion.tipo_cuerpo }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">No hay mediciones registradas aún.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {# FIN DEL DIV MODIFICADO #}

        </div>
    </div>

    {% include "includes/footer-fullscreen.html" %}

{% endblock content %}

{% block javascripts %}
  {{ block.super }}
  <!-- D3.js CDN (Necesario para el gráfico de peso en el dashboard) -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Tus scripts originales de Chart.js (si los necesitas para otros gráficos de Chart.js en el dashboard) -->
  <script src="/static/assets/vendor/chart.js/dist/Chart.min.js"></script>
  <script src="/static/assets/vendor/chart.js/dist/Chart.extension.js"></script>

  <script>
    // Datos pasados desde Django para el gráfico de Peso (D3.js) en el dashboard
    const dataPesoDashboard = JSON.parse('{{ fechas_pesos_json_dashboard|safe }}');

    console.log("Datos 'dataPesoDashboard' para D3.js (parsed):", dataPesoDashboard); // Para depuración

    // --- LÓGICA DEL GRÁFICO DE PESO (D3.js) para el DASHBOARD ---
    // Referencia al elemento donde se mostrará el peso seleccionado en el HTML.
    const selectedWeightDisplayDashboard = document.getElementById('selected-weight-display-dashboard');

    // Variable para mantener el rastro del punto seleccionado previamente.
    let previousSelectedDotDashboard = null; // Usar nombre diferente para evitar conflictos si existe otro

    // Configuración de márgenes para el gráfico.
    const marginDashboard = { top: 20, right: 30, bottom: 40, left: 50 };

    // Selecciona el contenedor del gráfico.
    const containerDashboard = d3.select("#weight-chart-container-dashboard");

    // Crea el elemento SVG principal y un grupo (g) para el contenido del gráfico.
    let svgElementDashboard = containerDashboard.select("svg");
    if (svgElementDashboard.empty()) {
        svgElementDashboard = containerDashboard.append("svg");
        svgElementDashboard.append("g")
            .attr("transform", `translate(${marginDashboard.left},${marginDashboard.top})`);
    }
    const svgDashboard = svgElementDashboard.select("g"); // Selecciona el grupo interno para el resto de operaciones


    // Analizador de fechas para convertir cadenas de texto a objetos Date.
    const parseDateDashboard = d3.timeParse("%Y-%m-%d");

    // Función para inicializar o redibujar el gráfico en el dashboard.
    function initWeightChartDashboard() {
        const containerNodeDashboard = containerDashboard.node();
        if (!containerNodeDashboard) {
            console.error("Contenedor #weight-chart-container-dashboard no encontrado.");
            return;
        }

        if (typeof dataPesoDashboard === 'undefined' || dataPesoDashboard.length === 0) {
            selectedWeightDisplayDashboard.textContent = "No hay datos de peso disponibles para mostrar.";
            svgElementDashboard.html('');
            return;
        }

        dataPesoDashboard.forEach(d => {
            d.fecha = parseDateDashboard(d.fecha);
            d.peso = +d.peso;
        });

        const containerRectDashboard = containerNodeDashboard.getBoundingClientRect();
        let widthDashboard = containerRectDashboard.width - marginDashboard.left - marginDashboard.right;
        let heightDashboard = containerRectDashboard.height - marginDashboard.top - marginDashboard.bottom;

        console.log("D3.js Dashboard: Dimensiones calculadas (width, height) para el gráfico:", widthDashboard, heightDashboard);

        if (widthDashboard <= 0 || heightDashboard <= 0) {
            console.warn("D3.js Dashboard: Las dimensiones del contenedor son insuficientes para dibujar el gráfico. Width:", widthDashboard, "Height:", heightDashboard);
            selectedWeightDisplayDashboard.textContent = "El espacio del gráfico es muy pequeño para mostrarlo.";
            svgElementDashboard.html('');
            return;
        }

        svgElementDashboard.attr("width", widthDashboard + marginDashboard.left + marginDashboard.right);
        svgElementDashboard.attr("height", heightDashboard + marginDashboard.top + marginDashboard.bottom);
        svgDashboard.attr("transform", `translate(${marginDashboard.left},${marginDashboard.top})`);

        const xScaleDashboard = d3.scaleTime()
            .domain(d3.extent(dataPesoDashboard, d => d.fecha))
            .range([0, widthDashboard]);

        const yScaleDashboard = d3.scaleLinear()
            .domain([d3.min(dataPesoDashboard, d => d.peso) - 1, d3.max(dataPesoDashboard, d => d.peso) + 1])
            .range([heightDashboard, 0]);

        const lineGeneratorDashboard = d3.line()
            .x(d => xScaleDashboard(d.fecha))
            .y(d => yScaleDashboard(d.peso))
            .curve(d3.curveMonotoneX);

        const pathDashboard = svgDashboard.selectAll(".line").data([dataPesoDashboard]);
        pathDashboard.enter().append("path")
            .attr("class", "line")
            .merge(pathDashboard)
            .attr("d", lineGeneratorDashboard);

        const dotsDashboard = svgDashboard.selectAll(".dot").data(dataPesoDashboard);
        dotsDashboard.enter().append("circle")
            .attr("class", "dot")
            .merge(dotsDashboard)
            .attr("cx", d => xScaleDashboard(d.fecha))
            .attr("cy", d => yScaleDashboard(d.peso))
            .attr("r", 4)
            .on("click", function(event, d) {
                if (previousSelectedDotDashboard) {
                    d3.select(previousSelectedDotDashboard).attr("class", "dot");
                }
                d3.select(this).attr("class", "dot selected");
                previousSelectedDotDashboard = this;
                selectedWeightDisplayDashboard.textContent = `Peso: ${d.peso} kg (${d3.timeFormat("%d/%m/%Y")(d.fecha)})`;
            });
        dotsDashboard.exit().remove();

        const xAxisDashboard = svgDashboard.selectAll(".x.axis").data([null]);
        xAxisDashboard.enter().append("g")
            .attr("class", "x axis")
            .merge(xAxisDashboard)
            .attr("transform", `translate(0,${heightDashboard})`)
            .call(d3.axisBottom(xScaleDashboard).tickFormat(d3.timeFormat("%b %Y")));

        const yAxisDashboard = svgDashboard.selectAll(".y.axis").data([null]);
        yAxisDashboard.enter().append("g")
            .attr("class", "y axis")
            .merge(yAxisDashboard)
            .call(d3.axisLeft(yScaleDashboard));
    }

    document.addEventListener('DOMContentLoaded', function() {
        initWeightChartDashboard();
    });

    window.addEventListener('resize', initWeightChartDashboard);

    selectedWeightDisplayDashboard.textContent = "Haz clic en un punto para ver el peso.";

  </script>

{% endblock javascripts %}